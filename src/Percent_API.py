import numpy as np
import pandas as pd
from scipy.sparse import lil_matrix, csr_matrix,save_npz,load_npz
from sklearn import svm
from scipy.sparse import hstack
from collections import defaultdict
import json 
from scipy import sparse
from scipy.sparse import rand
from scipy.sparse import csr_matrix
from scipy.sparse import coo_matrix, vstack
import scipy.stats as stats
from tqdm import tqdm


def percentAPI(AmatrixPath, labelPath):
    
    Amatrix = load_npz(AmatrixPath).todense()
    labels = pd.read_csv(labelPath, names=['Label'])
    
    df = pd.concat([pd.DataFrame(Amatrix), labels], axis=1)
    vals = df['Label'].value_counts()
    catagory = df.groupby(['Label']).sum().transpose()
    
    count = 0
    for i in catagory:
        catagory[i] = catagory[i].div(vals[count])
        count += 1

    return(catagory.transpose())



def perDiff(percentIn, thresholdBenign): 
    
    difPer = defaultdict(list)
    
    for i in range(percentIn.shape[1]):
        
        #Make sure its possibly "malware" API
        diff1 = percentIn[i][1] - percentIn[i][0]
        diff2 = percentIn[i][2] - percentIn[i][0]
        diff3 = percentIn[i][3] - percentIn[i][0]
        diff4 = percentIn[i][4] - percentIn[i][0]
        
        #Make sure its definitly a malware API
        if (diff1 > thresholdBenign or diff2 > thresholdBenign or diff3 > thresholdBenign or diff4 > thresholdBenign):
            difPer['Malware_APIs'].append(i)
            
    return difPer


def perDiffBenign(percentIn, thresholdBenign): 
    
    difPer = defaultdict(list)
    
    print("Getting the percentage each API appears in every app catagory...")
    for i in tqdm(range(percentIn.shape[1])):
        
        #Make sure its definintly malware
        diff1 = percentIn[i][0] - percentIn[i][1]
        diff2 = percentIn[i][0] - percentIn[i][2]
        diff3 = percentIn[i][0] - percentIn[i][3]
        diff4 = percentIn[i][0] - percentIn[i][4]
        
        if (diff1 > thresholdBenign and diff2 > thresholdBenign and diff3 > thresholdBenign and diff4 > thresholdBenign):
            difPer['Benign_APIs'].append(i)
            
    return difPer


def getAPIs(path):
    # Opening JSON file 
    with open(path) as json_file: 
        API_index = json.load(json_file) 

    API_index_swap = dict([(value, key) for key, value in API_index.items()]) 
    return API_index_swap



def filterSame(dic):
    
    setDict = defaultdict(list)
    for val in dic:
        setDict[val].append(list(set(dic[val])))
    return setDict
    
    
    
def getAPIuseIdx(setDict, APIDict, outpath, percentIn):
    
    realAPIs = defaultdict(list)
    
    for key in setDict:
        for idxs in setDict[key]:
            for i in idxs: 
                realAPIs[APIDict[i]].append([percentIn[i][0], percentIn[i][1], percentIn[i][2], percentIn[i][3], percentIn[i][4]])
                
    realAPIs = dict(sorted(realAPIs.items(), key=lambda x: x[1][0], reverse=True))
    
    with open(outpath, 'w') as fp:
        json.dump(realAPIs, fp)
    
    return realAPIs


def main(p):
    
    print("Getting training A-Matrix Percentages...")
    percentIn = percentAPI(p+'/Matrix_data/a_matrix_train.npz', p+'/Matrix_data/training_labels.csv')   
    
    print("Filtering APIs based on threshold value...")

    dicMal = perDiff(percentIn, .40, .60)
    dicBen = perDiffBenign(percentIn, .70)


    dicMal = perDiff(percentIn, .40)
    dicBen = perDiffBenign(percentIn, .60)


    MalAPIs = getAPIuseIdx(filterSame(dicMal), getAPIs(p+'/apis.json'), p+'/Malware_APIs.json', percentIn)   
    benAPIs = getAPIuseIdx(filterSame(dicBen), getAPIs(p+'/apis.json'), p+'/Benign_APIs.json', percentIn)
    
    
if _name_ == '_main_':
    main()
