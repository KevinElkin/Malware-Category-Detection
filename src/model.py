from sklearn.metrics import classification_report
from sklearn.model_selection import train_test_split
from sklearn import svm
from sklearn.metrics import multilabel_confusion_matrix

def run_model(p,kernels,malware):
    y = [0] * kernels['a_at'].shape[0]
    i = 1
    for family,apps in malware.items():
        for app_id in apps:
            y[app_id] = i
        i += 1
    clf = svm.LinearSVC(C=0.1, multi_class = 'ovr', dual = False)
    for k,x in kernels.items():
        X_train, X_test, y_train, y_test = train_test_split(x, y, test_size=0.33, random_state=42)
        clf.fit(X_train, y_train)
        preds = clf.predict(X_test)
        target_names = ['Benign'] + list(malware.keys())
        report = classification_report(y_test,preds, target_names=target_names)
        report_2 = multilabel_confusion_matrix(y_test, preds)
        
        with open(p + '/report_'+ k + '.txt','w') as f:
            f.write(report)
            for i,m in enumerate(report_2):
                f.write(target_names[i])
                f.write(m)
                      

            
