from sklearn.metrics import classification_report
from sklearn.model_selection import train_test_split
from sklearn import svm
from sklearn.metrics import multilabel_confusion_matrix
import numpy as np
import src.Malware_Types as mt

def run_model(p,train_kernels, test_kernels,malware_train,malware_test):
    df = mt.getMalwareData()
    y_train = [0] * train_kernels['a_at'].shape[0]
    y_test = [0] * test_kernels['a_at'].shape[0]
    
    labels = {}
    for family,apps in malware_train.items():
        mal_type = (mt.condensedFaimlyData(df,family)['Malware_Type'].iloc[0])
        if 'Trojan' in mal_type:
            mal_type = 'Trojan'
        if mal_type not in labels:
            labels[mal_type] = len(labels) + 1
        
        i = labels[mal_type]
        for app_id in apps:
            y_train[app_id] = i
            
            
    for family,apps in malware_test.items():
        mal_type = (mt.condensedFaimlyData(df,family)['Malware_Type'].iloc[0])
        if 'Trojan' in mal_type:
            mal_type = 'Trojan'

        i = labels[mal_type]
        for app_id in apps:
            y_test[app_id] = i

    clf = svm.LinearSVC(C=0.1, multi_class = 'ovr', dual = False)
    target_names = ['Benign'] + list(labels.keys())
    f = open(p + '/report.txt','w') 
    for k,x in train_kernels.items():
        clf.fit(x, y_train)
        X_test = test_kernels[k]
        preds = clf.predict(X_test)
        
        report = classification_report(y_test,preds, target_names=target_names)
        report_2 = multilabel_confusion_matrix(y_test, preds)
        
        f.write(k)
        f.write(report)
        f.write('\n') 
        for i,m in enumerate(report_2):
            f.write(target_names[i])
            f.write('\n')
            np.savetxt(f, m.round(2), delimiter=",")
        f.write('\n')
        np.savetxt(f, clf.coef_, delimiter=",")
        f.write('\n')
        np.savetxt(f, clf.intercept_, delimiter=",")

        f.write('\n')
    f.close()
                      

            
