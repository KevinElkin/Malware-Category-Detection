
import src.scrape_apk as scraper
import src.create_matrices as cm
import src.model as model
import json
import os
from random import sample
import sys

def get_apk(**kwargs):
    """
    method to unzip apk files downloaded from APKPure.com
    """
    outpath = kwargs['outpath']
    scrape = kwargs['scrape_data']
    categories = kwargs['categories']
    num_apps = kwargs['number_of_apps_per_cat']
    reread = kwargs['re_read']
    malware_path = kwargs['malware_path']
    num_malware = kwargs['num_malware_apps']
    malware_cats = kwargs['malware_categories']
    if malware_cats == 'all':
        malware_cats = ["Andup","BankBot","Boxer","DroidKungFu","FakeAngry","FakeInst","FakeAV","FakeDoc","Gorpo",\
                        "Fjcon","GingerMaster","Kemoge","Koler","Ksapp","Kyview","Minimob","MobileTX",\
                        "Mtk","Nandrobox","Obad","Roop","RuMMS","SimpleLocker","SmsZombie","SpyBubble","Stealer",\
                        "Steek","Univert","Vidro","VikingHorde","Vmvol","Youmi"]

    if not os.path.exists(outpath):
            os.mkdir(outpath)
            
    
    if scrape:
        print('Scraping data')
        scraper.run_scraper(categories, num_apps,outpath)
    print('Getting API info')
    category_data,apps,apis,test_info, test_apps = cm.get_metadata(categories, outpath,reread)
    print('Getting malware info')
    if reread:
        category_data,apps,apis, malware,test_info, test_apps, malware_test = cm.get_malware(malware_path,num_malware ,category_data,apps,apis,malware_cats,test_info, test_apps)
    else:
        category_data,apps,apis, malware,test_info, test_apps, malware_test = cm.read_malware(malware_cats, outpath,category_data,apps,apis,test_info, test_apps)
    
    print("Number of apps: ", len(apps))
    print("Number of apis: ", len(apis))
    cm.save_apps_apis(outpath,apps,apis)
    print('Creating kernels')
    train_kernels = cm.get_kernels(category_data,apps,apis)
    test_kernels = cm.get_kernels(test_info,test_apps,apis)
    
    print('Training SVM')
    model.run_model(outpath,train_kernels, test_kernels,malware, malware_test)

    
    
    
    


if __name__== "__main__":
    if sys.argv[1] == 'test-project':
        cfg = json.load(open('./config/test-params.json'))
    else:
        #params - number_of_xml_files, number_of_apps_per_category
        cfg = json.load(open('./config/data-params.json'))
    get_apk(**cfg)